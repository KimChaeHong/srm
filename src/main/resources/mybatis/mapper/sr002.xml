<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="com.birdie.srm.dao.SR002MTDao">
	
	<!-- 승인된 SR 목록 조회 -->
	<select id="getSrAll" resultType="SR002MT">
	    SELECT 
	        A.APP_SR_ID, 
	        R.REL_SYS, 
	        R.SR_TITLE, 
	        R.REQ_DT, 
	        R.DUE_DT, 
	        A.RCP_STAT, 
	        R.SR_STAT
	    FROM 
	        TB_SR_002MT A 
	    JOIN 
	        TB_SR_001MT R ON A.SR_ID = R.SR_ID
	    WHERE 
	        A.DELT_YN = 'N'
	        AND R.SR_STAT = 'OK'
	</select>

	
	
	<!-- 승인된 SR 리스트 검색 기능 --> 
	<select id="getSearchedSr" parameterType="Map" resultType="SR002MT">	    
	    SELECT
	        RNUM, APP_SR_ID, SR_ID, SR_TITLE, REL_SYS, 
        	FIRST_INPT_ID, RCP_STAT, REQ_DT, DUE_DT, TASK_TYPE
	    FROM (
	        SELECT
	            A.APP_SR_ID, R.SR_ID, R.SR_TITLE, R.REL_SYS, 
	            R.FIRST_INPT_ID, A.RCP_STAT, R.REQ_DT, R.DUE_DT, NT.TASK_TYPE,
	            ROW_NUMBER() OVER (ORDER BY R.FIRST_INPT_DT DESC) AS RNUM
	        FROM TB_SR_002MT A 
	        JOIN TB_SR_001MT R ON A.SR_ID = R.SR_ID
	        JOIN TB_SR_002NT NT ON A.APP_SR_ID = NT.APP_SR_ID
	        WHERE A.DELT_YN = 'N'
          		<!-- AND R.SR_STAT = 'RECE' -->
	            <if test="searchDto.startDate != null and searchDto.endDate != null">		<!-- 조회기간 -->
	                AND R.FIRST_INPT_DT BETWEEN #{searchDto.startDate} AND #{searchDto.endDate}
	            </if>
	            <if test="searchDto.relSys != null and searchDto.relSys !=''">			<!-- 관련 시스템 -->
	                AND R.REL_SYS = #{searchDto.relSys}
	            </if>
	            <if test="searchDto.wkType != null and searchDto.wkType !=''">			<!-- 업무구분 -->
	                AND A.WK_TYPE = #{searchDto.wkType}
	            </if>
	            <if test="searchDto.keyword != null and searchDto.keyword !=''">			<!-- 제목 -->
	                AND (R.SR_TITLE LIKE '%' || #{searchDto.keyword} || '%' 
         			OR UPPER(R.SR_TITLE) LIKE UPPER('%' || #{searchDto.keyword} || '%'))
	            </if>
	            <if test="searchDto.tkType != null and searchDto.tkType !=''">			<!-- 진행상태 -->
	                AND NT.TASK_TYPE = #{searchDto.tkType}
	            </if>
	            <if test="searchDto.rcpStat != null and searchDto.rcpStat !=''">			<!-- 접수상태 -->
	                AND A.RCP_STAT = #{searchDto.rcpStat}
	           </if>
	          
	    	)
	    WHERE RNUM BETWEEN #{pager.startRowNo} AND #{pager.endRowNo}
	</select>
	
	<!-- 검색에 따라 반환되는 행 개수 -->
	<select id="countRows" parameterType="Search" resultType="int">
		select count(*)
		from TB_SR_002MT A
		JOIN TB_SR_001MT R ON A.SR_ID = R.SR_ID
		JOIN TB_SR_002NT NT ON A.APP_SR_ID = NT.APP_SR_ID
		where 1=1 
			<!-- <if test="startDate != null and startDate != '' and endDate != null and endDate != ''"> -->
			<if test="startDate != null and endDate != null">
				and R.FIRST_INPT_DT between #{startDate} and #{endDate}
			</if>
			<if test="relSys != null and relSys != ''">
				and R.REL_SYS = #{relSys}
			</if>
			<if test="wkType != null and wkType != ''">
				and A.WK_TYPE = #{wkType}
			</if>
			<if test="keyword != null and keyword != ''">
				and R.SR_TITLE LIKE '%' || #{keyword} || '%'
			</if>
			<if test="tkType != null and tkType != ''">
				and NT.TASK_TYPE = #{tkType}
			</if>
			<if test="rcpStat != null and rcpStat != ''">
				and A.RCP_STAT = #{rcpStat}
			</if>
			
	</select>
	
	<insert id="insertAppSr" parameterType="SR001MT">
		insert into TB_SR_002MT (
			SR_ID, FIRST_INPT_ID, FIRST_INPT_DT, LAST_INPT_ID, LAST_INPT_DT
		)	
		values (
			#{srId}, #{lastInptId}, sysdate, #{lastInptId}, sysdate
		)
	</insert>
	
	<!-- SR계획정보 조회 -->
	<select id="selectSrPlan" parameterType="String" resultType="SR002MT">
	    SELECT 
	    	A.APP_SR_ID,
	        A.SR_TYPE,           <!-- 요청 구분 -->
	        A.WK_TYPE,           <!-- 업무 구분 -->
	        A.TRG_ST_DT,         <!-- 목표 시작일 -->
	        A.TRG_END_DT,        <!-- 목표 완료일 -->
	        A.RCP_STAT,          <!-- 접수 상태 -->
	        A.RVW_CONT,          <!-- 검토 내용 -->
	        M.DEPT_ID,           <!-- 처리팀 부서 -->
	        M.MEM_NM AS MGR      <!-- 담당자 이름- MGR 필드로 매핑 -->
	    FROM TB_SR_002MT A
	    JOIN TB_MB_001MT M
	        ON A.MGR = M.MEM_NO   <!-- MGR(사번)으로 MEM_NO이랑 조인 -->
	    WHERE A.APP_SR_ID = #{appSrId}
	</select>
	
	<!-- SR계획정보 수정 -->
	<update id="updateSrPlan" parameterType="SR002MT">
		UPDATE TB_SR_002MT
		SET
			APP_SR_ID = #{appSrId},
			SR_TYPE = #{srType},
			WK_TYPE = #{wkType},
			TRG_ST_DT = #{trgStDt},
	        TRG_END_DT = #{trgEndDt},
	        RCP_STAT = #{rcpStat},
	        RVW_CONT = #{rvwCont},
	        FIRST_INPT_ID = #{firstInptId},
	        FIRST_INPT_DT = SYSDATE,
	        LAST_INPT_ID = #{lastInptId},
	        LAST_INPT_DT = SYSDATE
	    WHERE APP_SR_ID = #{appSrId}
	</update>
	
	
</mapper>